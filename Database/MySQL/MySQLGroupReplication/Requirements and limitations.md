<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->
# 组复制要求
用于组复制的服务器实例必须满足以下要求：

## 基础设施


- <font style="color: pink">InnoDB 存储引擎。  数据InnoDB必须存储在事务存储引擎中。 事务以乐观的方式执行，并在提交时检查是否存在冲突。 如果存在冲突，则回滚一些事务以保持组之间的一致性。 这意味着您需要一个事务存储引擎。 此外，InnoDB还提供了一些附加功能，可在使用组复制时改善冲突管理和处理。 使用其他存储引擎（包括临时MEMORY存储引擎）可能会导致组复制出现错误。 您可以通过设置系统变量来阻止组成员`disabled_storage_engines`使用其他存储引擎。例如：</font>

- <font style="color: pink">`disabled_storage_engines="MyISAM,BLACKHOLE,FEDERATED,ARCHIVE,MEMORY"`主键。  组复制的所有表都必须具有已定义的主键或等效主键`（等效的非 NULL 唯一键）`。 这样的键是表中每一行的唯一标识符。这使得系统能够通过准确识别每个事务修改了哪些行来确定冲突的事务。组复制有自己的一组针对主键或相当于主键的内置检查，并且`sql_require_primary_key`不使用系统变量执行的检查。您可以为运行组复制的服务器实例`sql_require_primary_key=ON`设置此项，并且可以为组复制通道设置语句`CHANGE REPLICATION SOURCE TO选项。 但是请注意，组复制的内置检查允许的某些事务可能不被您配置或时执行的检查所允许 。CHANGE MASTER TOREQUIRE_TABLE_PRIMARY_KEY_CHECKONsql_require_primary_key=ONREQUIRE_TABLE_PRIMARY_KEY_CHECK=ON`</font>

- <font style="color: pink">网络性能。MySQL  组复制旨在部署在服务器实例彼此靠近的集群环境中。 网络延迟和网络带宽都会影响组的性能和稳定性。 所有小组成员之间必须始终保持双向沟通。 如果服务器实例上的入站或出站通信被阻止（例如，由于防火墙或连接问题），则该成员将无法在组内发挥作用，并且组成员（包括有问题的成员）可能无法报告受影响的服务器实例的正确成员状态。
</font>

从 MySQL 8.0.14 开始，远程组复制服务器之间的 `TCP` 通信可以使用 IPv4 或 IPv6 网络基础设施，或两者的组合。 此外，`组复制不会停止通过虚拟专用网络 (VPN) 进行的工作。此外，从 MySQL 8.0.14 开始，组复制服务器实例位于同一位置并共享本地组通信引擎(XCom) `实例，只要有可能，就会使用专用的、低开销的输入通道而不是 TCP 套接字进行通信。 某些需要远程 XCom 实例之间通信的组复制任务（例如加入组）仍将使用 TCP 网络，因此网络性能将影响组性能。

## 服务器实例配置
必须将以下选项配置为对属于组成员的服务器实例可见：
+ 唯一服务器标识符,  根据复制拓扑中所有服务器的要求，`server_id`使用系统变量为服务器配置唯一的服务器 `ID`。 服务器 `ID` 必须是 1 到 (2 32 )-1之间的正整数，并且必须与复制拓扑中其他服务器使用的所有其他服务器 ID 不同。

+ 启用二进制日志, `--log-bin[=log_file_name]`设置为活动状态。 MySQL Group Replication 复制二进制日志的内容，因此必须打开二进制日志才能对其进行操作。 默认情况下启用此选项。请参见 第 5.4.4 节“二进制日志” 。

+ `--log-slave-updates`设置记录的副本更新 。 默认情况下启用此选项。 组成员在加入时必须记录从捐赠者收到的交易并通过复制设备申请，并且必须记录从组收到的所有交易并申请。 这允许组复制通过从现有组成员二进制日志进行状态传输来执行分布式恢复。

+ `--binlog-format=row`设置二进制日志行格式。  组复制依赖于基于行的复制格式来在组中的服务器之间一致地传播更改。 它依赖于基于行的基础设施来提取检测组中不同服务器上同时执行的事务之间冲突所需的信息。从 MySQL 8.0.19 开始，REQUIRE_ROW_FORMAT在应用事务时，会自动向组复制通道添加一个设置，以强制使用基于行的复制。请参见 第 17.2.1 节“复制格式”和第 17.3.3 节“复制权限检查” 。

+ `--binlog-checksum=NONE`将二进制日志校验和设置为关闭（MySQL 8.0.20）。  最高版本为 MySQL 8.0.20 。 在这些版本中，组复制不能使用校验和，并且不支持二进制日志中存在校验和。从 MySQL 8.0.21 开始，组复制支持校验和，因此组成员可以使用默认设置。

+ 设置全局事务标识符的开启 `gtid_mode=ON`或关闭。`enforce_gtid_consistency=ON` 组复制使用全局事务标识符来精确跟踪所有服务器实例上已提交的事务，从而可以推断哪些服务器执行了可能与已提交的事务冲突的事务。 换句话说，明确的交易标识符是框架的基本组成部分，可以确定潜在的冲突交易。请参见 第 17.1.3 节“使用全局事务标识符进行复制” 。

+ `master_info_repository=TABLE`配置复制信息存储库 `relay_log_info_repository=TABLE`。在 MySQL 8.0 中，此设置是默认设置，并且FILE该设置已被弃用。从 MySQL 8.0.23 开始，这些系统变量已被弃用，因此请省略系统变量并接受默认值。为了使组复制插件具有一致的可恢复性和复制元数据的事务管理，复制设备需要将复制元数据写入系统表`mysql.slave_master_info`。请参见 第 17.2.4.2 节“复制元数据存储库” 。`mysql.slave_relay_log_info`

+ 事务写入集提取。 `--transaction-write-set-extraction=XXHASH64`配置 服务器在收集行并将其记录到二进制日志中时收集写入集。 写入集基于每行的主键，并且是唯一标识已修改行的标签的简化、紧凑视图。 该标签用于冲突检测。 默认情况下启用此选项。

+ 配置二进制日志依赖关系跟踪  `binlog_transaction_dependency_tracking=WRITESET_SESSION`可以根据组工作负载提高组成员的性能。`binlog_transaction_dependency_tracking`无论为 设定的值如何，组复制在从中继日志应用事务时，都会在证明之后执行其自己的并行性。 但是，`binlog_transaction_dependency_tracking`的值确实会影响事务如何写入组复制成员的二进制日志。 这些日志中的依赖信息用于帮助从捐助二进制日志进行分布式恢复的状态转移过程，每当成员加入或重新加入组时就会发生该过程。

默认表加密。  为所有组成员`--default-table-encryption`设置为相同的值。 默认架构和表空间加密可以 启用`（ ON）`或禁用`（ ，默认），`只要所有成员的设置相同即可。`OFF`

小写的表名。  为所有组成员`--lower-case-table-names`设置为相同的值。 InnoDB设置为 1 适合使用组复制所需的存储引擎。 此设置并非在所有平台上都是默认设置。

多线程设备。  组复制成员可以配置为多线程副本，从而允许并行应用事务。`slave_parallel_workers`非零值启用成员的多线程设备，允许最多 1024 个并行应用程序线程。`slave_preserve_commit_order=1`设置后，并行事务的最终提交将按照与组复制所需的原始事务相同的顺序发生。它依赖于建立一致性机制来保证所有参与成员以相同的顺序接收和应用已提交的事务。 最后，需要 `slave_parallel_type=LOGICAL_CLOCK`一个设置来指定用于确定哪些事务可以在副本上并行执行的策略。设置禁用并行执行，并为副本提供单个应用线程，而不提供协调器线程。 使用此设置，和选项无效并将被忽略。 `slave_preserve_commit_order=1slave_parallel_workers=0slave_parallel_typeslave_preserve_commit_order`

# 组复制限制
组复制具有以下已知限制： 针对多主模式组描述的限制和问题也适用于单主模式集群，但在故障转移事件期间，新选举的主节点将从旧主节点中刷新应用程序队列。
> [!WARNING]
> 由于组复制建立在基于 GTID 的复制之上，因此您还应该注意[基于 GTID 的复制的限制](#组复制限制) 。

+ `--upgrade=MINIMA`L可选。 `--upgrade=MINIMAL`升级使用` MINIMAL `选项 `() `的 MySQL 服务器后 ，无法启动组复制，因为该选项不会升级复制内部所依赖的系统表。

+ 间隙锁。  间隙锁的信息InnoDB在 之外不可用，因此在并发事务的组复制保证过程中不考虑间隙锁。 有关详细信息，请参阅 间隙锁。

> [!NOTE]
> 对于多主模式下的组，我们建议使用`REPEATABLE READ`组复制的隔离级别，除非您的应用程序依赖于语义。 `READ COMMITTEDInnoDBREAD COMMITTED`不使用间隙锁定。这使 InnoDB 中的本地冲突检测与组复制执行的分布式冲突检测保持一致。 对于单主模式下的组，只有主服务器接受写入，因此`READ COMMITTED`隔离级别对于组复制并不重要。

表锁和命名锁。  认证过程不考虑 表锁[参见`LOCK TABLES `和 `UNLOCK TABLES` 语句”](https://dev.mysql.com/doc/refman/8.0/ja/lock-tables.html)或命名锁（参见）。GET_LOCK()

二进制日志校验和。  在 MySQL 8.0.20 之前，组复制不能使用校验和，也不支持二进制日志中存在校验和，因此`binlog_checksum=NONE`在将服务器实例配置为组成员时必须设置它们。从 MySQL 8.0.21 开始，组复制支持校验和，允许组成员`binlog_checksum=CRC32`使用默认设置。`binlog_checksum`群组内所有成员的设置无需相同。

如果有校验和，组复制不会使用它们`group_replication_applier`来验证通道上的传入事件。这是因为事件从多个来源写入该中继日志，并且在实际写入原始服务器的二进制日志之前（生成校验和时）。 校验`group_replication_recovery`和用于验证该通道以及组成员上的其他复制通道上事件的完整性。

`SERIALIZABLE` 隔离级别。  `SERIALIZABLE`多主组默认不支持隔离级别。 设置事务隔离级别`SERIALIZABLE`以配置组复制以拒绝提交事务。

并发 `DDL` 和 `DML` 操作。  使用多主模式时，不支持对同一对象但不同服务器上的并发数据定义和数据操作语句进行操作。 当对某个对象执行数据定义语言` (DDL) `语句时，如果对不同服务器实例上的同一对象执行并发数据操作语言 (DML)，则存在无法检测到不同实例上冲突的 DDL 的风险。

具有级联约束的外键。  多主模式组`（group_replication_single_primary_mode=OFF由其所有成员组成）`不支持具有多级外键依赖关系的表`（特别是定义了CASCADING 外键约束的表）`。 这是因为多主模式组执行级联操作的外键约束可能导致组成员之间未检测到的冲突和数据不一致。 因此，`group_replication_enforce_update_everywhere_checks=ON`建议 在多主模式组中使用的服务器实例上进行设置，以避免未检测到的冲突。

在单主模式下这不是问题，因为不允许同时向组的多个成员进行写入。因此，不存在未被发现的冲突的风险。

多主模式下的死锁。  如果一个组在多主模式下运行，`SELECT .. FOR UPDATE`则语句可能会导致死锁。 这是因为这种语句的期望可能无法达到，因为锁不在组成员之间共享。

复制过滤器。  为组复制配置的 MySQL 服务器实例不能使用全局复制过滤器。这是因为在某些服务器上过滤交易会阻止团队在一致状态下达成一致。 您可以在不直接参与组复制的复制通道上使用特定于通道的复制过滤器，例如当组成员也作为组外源的副本时。`group_replication_applier`或`group_replication_recovery`频道。

加密连接。  从 `MySQL 8.0.16` 开始，MySQL Server 中支持 `TLSv1.3` 协议（前提是 MySQL 是使用 `OpenSSL 1.1.1` 或更高版本编译的）。在 `MySQL 8.0.16` 和 `MySQL 8.0.17` 中，如果服务器支持 `TLSv1.3`，则组通信引擎不支持该协议，并且不能与组复制一起使用。 从 `MySQL 8.0.18` 开始，组复制支持 `TLSv1.3`，用于组通信连接和分布式恢复连接。

在 `MySQL 8.0.18` 中，TLSv1.3 可用于组复制以实现分布式恢复连接，但不能用于系统变量`group_replication_recovery_tls_version`。`group_replication_recovery_tls_ciphersuites` 因此，捐赠服务器必须至少有一个可用的 `TLSv1.3` 密码套件（默认启用），如第 6.3.2 节“加密连接 TLS 协议和密码”中列出。从 MySQL 8.0.19 开始，您可以使用选项来配置对任何密码套件的客户端支持，如果需要，仅包括非默认密码套件。

克隆操作。  尽管组复制启动并管理分布式恢复的克隆操作，但配置为支持克隆的组成员也可以参与用户手动启动的克隆操作。在 MySQL 8.0.20 之前的版本中，如果操作涉及运行组复制的组成员，则无法手动启动克隆操作。 从 MySQL 8.0.20 开始，如果克隆操作不会删除和替换收件人的数据，则可以执行此操作。 因此，如果正在执行组复制，则启动克隆操作的语句DATA DIRECTORY必须包含该子句。请参见 第 18.4.3.2.4 节“为其他目的进行克隆” 。